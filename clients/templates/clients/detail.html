{% extends 'base.html' %}

{% block title %}{{ client.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
        <div>
            <a href="{% url 'clients:list' %}" class="text-slate-400 dark:text-slate-500 hover:text-slate-700 dark:hover:text-white text-sm flex items-center gap-1 mb-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Alle Clients
            </a>
            <div class="flex items-center gap-3">
                <div class="relative">
                    {% if client.status == 'running' %}
                    <div class="w-4 h-4 bg-emerald-500 rounded-full"></div>
                    <div class="absolute inset-0 w-4 h-4 bg-emerald-500 rounded-full animate-ping opacity-75"></div>
                    {% elif client.status == 'error' %}
                    <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                    {% elif client.status == 'starting' or client.status == 'stopping' %}
                    <div class="w-4 h-4 bg-amber-500 rounded-full animate-pulse"></div>
                    {% else %}
                    <div class="w-4 h-4 bg-slate-500 rounded-full"></div>
                    {% endif %}
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ client.name }} <span class="text-slate-400 font-normal">({{ client.profile_name }})</span></h1>
                    <p class="text-slate-500">{{ client.slug }} · Port {{ client.websocket_port }}</p>
                </div>
            </div>
        </div>
        
        <!-- Actions - alle Buttons Cyan, kompakt -->
        <div class="flex flex-wrap gap-2">
            {% if client.status == 'running' %}
            <form method="post" action="{% url 'clients:stop' client.slug %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium transition-colors inline-flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                    </svg>
                    Stoppen
                </button>
            </form>
            <form method="post" action="{% url 'clients:restart' client.slug %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium transition-colors inline-flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Neustart
                </button>
            </form>
            {% else %}
            <form method="post" action="{% url 'clients:start' client.slug %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium transition-colors inline-flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Starten
                </button>
            </form>
            {% endif %}
            
            <a href="{% url 'clients:edit' client.slug %}" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium transition-colors inline-flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Bearbeiten
            </a>
            
            <a href="{% url 'clients:delete' client.slug %}" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium transition-colors inline-flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Löschen
            </a>
        </div>
    </div>

    {% if client.last_error %}
    <div class="bg-red-500/10 border border-red-500/50 rounded-xl p-4 text-red-400">
        <strong>Fehler:</strong> {{ client.last_error }}
    </div>
    {% endif %}

    <!-- Stats Cards -->
    {% include 'clients/partials/_stats.html' %}

    <!-- Main Grid - beide Spalten stretchen sich zur gleichen Höhe -->
    <div class="grid gap-6 lg:grid-cols-3" style="align-items: stretch;">
        <!-- Main Content - h-full damit es die Grid-Höhe ausfüllt -->
        <div class="lg:col-span-2 h-full flex flex-col space-y-6">
            {% include 'clients/partials/_connections.html' %}

            <!-- Container Logs -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden">
                <div class="p-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Container Logs</h2>
                    <button onclick="refreshLogs()" id="refresh-logs-btn" class="text-sm text-cyan-600 dark:text-cyan-400 hover:text-cyan-500 flex items-center gap-1">
                        <svg id="logs-spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="refresh-logs-text">Aktualisieren</span>
                    </button>
                </div>
                <div id="logs-container" class="p-4 font-mono text-xs text-slate-300 overflow-auto max-h-64 bg-slate-950 custom-scrollbar">
                    {% if container_logs %}<pre class="whitespace-pre-wrap">{{ container_logs }}</pre>{% else %}<p class="text-slate-500">Keine Logs verfügbar</p>{% endif %}
                </div>
            </div>
            
            <!-- Messages - FLEX-1 damit es wächst um Sidebar auszugleichen -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden flex-1 flex flex-col min-h-[300px]">
                <div class="border-b border-slate-200 dark:border-slate-800 flex-shrink-0">
                    <nav class="flex" id="message-tabs">
                        <button onclick="switchMessageTab('sent')" class="message-tab px-6 py-3 text-sm font-medium border-b-2 transition-colors text-cyan-600 dark:text-cyan-400 border-cyan-500" data-tab="sent">↑ Gesendet</button>
                        <button onclick="switchMessageTab('received')" class="message-tab px-6 py-3 text-sm font-medium border-b-2 transition-colors text-slate-500 border-transparent hover:text-slate-700 dark:hover:text-slate-300" data-tab="received">↓ Empfangen</button>
                        <button onclick="switchMessageTab('all')" class="message-tab px-6 py-3 text-sm font-medium border-b-2 transition-colors text-slate-500 border-transparent hover:text-slate-700 dark:hover:text-slate-300" data-tab="all">Alle</button>
                    </nav>
                </div>
                
                <!-- Message panels mit flex-1 -->
                <div id="messages-sent" class="message-panel flex-1 overflow-auto custom-scrollbar">
                    <table class="w-full">
                        <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Zeit</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Empfänger</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Nachricht</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-slate-500 uppercase">Latenz</th>
                            </tr>
                        </thead>
                        <tbody id="sent-messages-body" class="divide-y divide-slate-200 dark:divide-slate-800">
                            {% for msg in sent_messages %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50" data-message-id="{{ msg.id }}">
                                <td class="px-3 py-2 text-slate-500 text-sm whitespace-nowrap">{{ msg.created_at|date:"H:i:s" }}</td>
                                <td class="px-3 py-2 text-slate-900 dark:text-white">{{ msg.recipient_name }}</td>
                                <td class="px-3 py-2 text-slate-600 dark:text-slate-300 max-w-xs truncate">{{ msg.content|truncatechars:30 }}</td>
                                <td class="px-3 py-2 msg-status">{% if msg.delivery_status == 'delivered' %}<span class="text-emerald-500">✓✓</span>{% elif msg.delivery_status == 'sent' %}<span class="text-amber-500">✓</span>{% elif msg.delivery_status == 'failed' %}<span class="text-red-500">✗</span>{% else %}<span class="text-slate-400 animate-pulse">⏳</span>{% endif %}</td>
                                <td class="px-3 py-2 text-right text-slate-500 text-xs msg-latency">{% if msg.total_latency_ms %}{{ msg.total_latency_ms }}ms{% else %}-{% endif %}</td>
                            </tr>
                            {% empty %}
                            <tr id="no-sent-messages"><td colspan="5" class="px-3 py-8 text-center text-slate-500">Keine gesendeten Nachrichten</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div id="messages-received" class="message-panel hidden flex-1 overflow-auto custom-scrollbar">
                    <table class="w-full">
                        <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Zeit</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Absender</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Nachricht</th>
                            </tr>
                        </thead>
                        <tbody id="received-messages-body" class="divide-y divide-slate-200 dark:divide-slate-800">
                            {% for msg in received_messages %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50" data-message-id="{{ msg.id }}">
                                <td class="px-3 py-2 text-slate-500 text-sm whitespace-nowrap">{{ msg.received_at|date:"H:i:s" }}</td>
                                <td class="px-3 py-2 text-slate-900 dark:text-white">{{ msg.sender_name }}</td>
                                <td class="px-3 py-2 text-slate-600 dark:text-slate-300">{{ msg.content|truncatechars:50 }}</td>
                            </tr>
                            {% empty %}
                            <tr id="no-received-messages"><td colspan="3" class="px-3 py-8 text-center text-slate-500">Keine empfangenen Nachrichten</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div id="messages-all" class="message-panel hidden flex-1 overflow-auto custom-scrollbar">
                    <table class="w-full">
                        <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Zeit</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Typ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Kontakt</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Nachricht</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-slate-500 uppercase">Latenz</th>
                            </tr>
                        </thead>
                        <tbody id="all-messages-body" class="divide-y divide-slate-200 dark:divide-slate-800">
                            {% for msg in all_messages %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50" data-message-id="{{ msg.id }}">
                                <td class="px-3 py-2 text-slate-500 text-sm whitespace-nowrap">{{ msg.created_at|date:"H:i:s" }}</td>
                                <td class="px-3 py-2">{% if msg.direction == 'sent' %}<span class="text-emerald-500 text-xs">↑ OUT</span>{% else %}<span class="text-cyan-500 text-xs">↓ IN</span>{% endif %}</td>
                                <td class="px-3 py-2 text-slate-900 dark:text-white">{{ msg.contact_name }}</td>
                                <td class="px-3 py-2 text-slate-600 dark:text-slate-300 max-w-xs truncate">{{ msg.content|truncatechars:30 }}</td>
                                <td class="px-3 py-2 msg-status">{% if msg.delivery_status == 'delivered' %}<span class="text-emerald-500">✓✓</span>{% elif msg.delivery_status == 'sent' %}<span class="text-amber-500">✓</span>{% elif msg.delivery_status == 'failed' %}<span class="text-red-500">✗</span>{% else %}<span class="text-slate-400 animate-pulse">⏳</span>{% endif %}</td>
                                <td class="px-3 py-2 text-right text-slate-500 text-xs msg-latency">{% if msg.total_latency_ms %}{{ msg.total_latency_ms }}ms{% else %}-{% endif %}</td>
                            </tr>
                            {% empty %}
                            <tr id="no-all-messages"><td colspan="6" class="px-3 py-8 text-center text-slate-500">Keine Nachrichten</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Sidebar - h-full damit es die Grid-Höhe ausfüllt -->
        <div class="lg:col-span-1 h-full">
            {% include 'clients/partials/_sidebar.html' %}
        </div>
    </div>
    
    <!-- Grafana Info Box -->
    <div class="bg-cyan-50 dark:bg-cyan-900/20 border border-cyan-200 dark:border-cyan-800 rounded-xl p-4 flex items-start space-x-3">
        <svg class="w-6 h-6 text-cyan-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
            <p class="font-medium text-cyan-900 dark:text-cyan-300">Grafana Dashboard</p>
            <p class="text-sm text-cyan-700 dark:text-cyan-400">
                Metrics werden nach InfluxDB geschrieben. Öffne
                <a href="http://localhost:3000" target="_blank" class="underline hover:no-underline">Grafana (localhost:3000)</a>
                für detaillierte Visualisierungen.
            </p>
        </div>
    </div>
</div>

<style>
.custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
.custom-scrollbar::-webkit-scrollbar-track { background: rgb(15 23 42); border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgb(51 65 85); border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgb(71 85 105); }
.custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgb(51 65 85) rgb(15 23 42); }

@keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slide-in-right { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slide-out-right { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(30px); } }
@keyframes slide-in-left { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slide-out-left { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-30px); } }
@keyframes stat-bump { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

.animate-fade-in { animation: fade-in 0.3s ease-out; }
.animate-slide-in-right { animation: slide-in-right 0.15s ease-out forwards; }
.animate-slide-out-right { animation: slide-out-right 0.15s ease-out forwards; }
.animate-slide-in-left { animation: slide-in-left 0.15s ease-out forwards; }
.animate-slide-out-left { animation: slide-out-left 0.15s ease-out forwards; }
.stat-bump { animation: stat-bump 0.3s ease-out; }
.connection-item { overflow: hidden; }
</style>

<script>
const CLIENT_SLUG = '{{ client.slug }}';
const CSRF_TOKEN = '{{ csrf_token }}';
const LOGS_URL = '{% url "clients:logs" client.slug %}';
const SEND_URL = '{% url "clients:send_message" %}';
const CONNECT_URL = '{% url "clients:connect" client.slug %}';
const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const WS_HOST = window.location.host;

function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

function switchMessageTab(tab) {
    document.querySelectorAll('.message-tab').forEach(btn => {
        if (btn.dataset.tab === tab) { btn.classList.add('text-cyan-600', 'dark:text-cyan-400', 'border-cyan-500'); btn.classList.remove('text-slate-500', 'border-transparent'); }
        else { btn.classList.remove('text-cyan-600', 'dark:text-cyan-400', 'border-cyan-500'); btn.classList.add('text-slate-500', 'border-transparent'); }
    });
    document.querySelectorAll('.message-panel').forEach(p => p.classList.add('hidden'));
    document.getElementById('messages-' + tab)?.classList.remove('hidden');
}

function showConnectPanel() {
    const normalHeader = document.getElementById('connections-header-normal');
    const connectHeader = document.getElementById('connections-header-connect');
    if (!normalHeader || !connectHeader) return;
    resetConnectPanel();
    normalHeader.classList.add('animate-slide-out-left');
    setTimeout(() => { normalHeader.classList.add('hidden'); normalHeader.classList.remove('animate-slide-out-left'); connectHeader.classList.remove('hidden'); connectHeader.classList.add('animate-slide-in-right'); }, 150);
}

function hideConnectPanel() {
    const normalHeader = document.getElementById('connections-header-normal');
    const connectHeader = document.getElementById('connections-header-connect');
    if (!normalHeader || !connectHeader) return;
    connectHeader.classList.remove('animate-slide-in-right');
    connectHeader.classList.add('animate-slide-out-right');
    setTimeout(() => { connectHeader.classList.add('hidden'); connectHeader.classList.remove('animate-slide-out-right'); normalHeader.classList.remove('hidden'); normalHeader.classList.add('animate-slide-in-left'); setTimeout(() => normalHeader.classList.remove('animate-slide-in-left'), 150); }, 150);
}

function resetConnectPanel() {
    document.getElementById('connect-normal')?.classList.remove('hidden');
    document.getElementById('connect-loading')?.classList.add('hidden');
    document.getElementById('connect-success')?.classList.add('hidden');
    document.getElementById('connect-error')?.classList.add('hidden');
}

function showDeleteConfirm(connectionId) { const item = document.querySelector(`[data-connection-id="${connectionId}"]`); if (!item) return; item.querySelector('.connection-normal')?.classList.add('hidden'); item.querySelector('.connection-confirm')?.classList.remove('hidden'); }
function cancelDelete(connectionId) { const item = document.querySelector(`[data-connection-id="${connectionId}"]`); if (!item) return; item.querySelector('.connection-confirm')?.classList.add('hidden'); item.querySelector('.connection-normal')?.classList.remove('hidden'); }

async function confirmDelete(connectionId) {
    const item = document.querySelector(`[data-connection-id="${connectionId}"]`);
    if (!item) return;
    const clientNameEl = item.querySelector('.font-medium');
    const clientName = clientNameEl?.textContent || '';
    item.querySelector('.connection-confirm')?.classList.add('hidden');
    item.querySelector('.connection-deleting')?.classList.remove('hidden');
    try {
        const response = await fetch(`/clients/connections/${connectionId}/delete/`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN } });
        const data = await response.json();
        if (data.success) {
            const contactSelect = document.getElementById('contact-select');
            if (contactSelect) { for (let i = 0; i < contactSelect.options.length; i++) { if (contactSelect.options[i].getAttribute('data-recipient') === clientName) { contactSelect.remove(i); break; } } }
            item.style.transition = 'all 0.3s ease-out'; item.style.maxHeight = item.offsetHeight + 'px';
            requestAnimationFrame(() => { item.style.maxHeight = '0'; item.style.opacity = '0'; item.style.paddingTop = '0'; item.style.paddingBottom = '0'; });
            setTimeout(() => {
                item.remove();
                const list = document.getElementById('connections-list');
                const remaining = list?.querySelectorAll('.connection-item');
                if (!remaining || remaining.length === 0) {
                    document.getElementById('send-message-container')?.classList.add('hidden');
                    document.getElementById('no-connections-send-placeholder')?.classList.remove('hidden');
                    const placeholder = document.createElement('div'); placeholder.id = 'no-connections-placeholder'; placeholder.className = 'p-8 text-center';
                    placeholder.innerHTML = '<div class="w-12 h-12 mx-auto mb-3 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center"><svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg></div><p class="text-slate-500">Keine Verbindungen</p>';
                    list.appendChild(placeholder);
                }
            }, 300);
        } else { item.querySelector('.connection-deleting')?.classList.add('hidden'); item.querySelector('.connection-normal')?.classList.remove('hidden'); }
    } catch (error) { console.error('Delete error:', error); item.querySelector('.connection-deleting')?.classList.add('hidden'); item.querySelector('.connection-normal')?.classList.remove('hidden'); }
}

let logsLoading = false;
function refreshLogs() {
    if (logsLoading) return;
    const container = document.getElementById('logs-container'); const spinner = document.getElementById('logs-spinner'); const btnText = document.getElementById('refresh-logs-text');
    logsLoading = true; spinner?.classList.remove('hidden'); if (btnText) btnText.textContent = 'Laden...';
    fetch(LOGS_URL).then(r => r.json()).then(data => { if (container) { container.innerHTML = data.logs?.trim() ? '<pre class="whitespace-pre-wrap text-xs">' + escapeHtml(data.logs) + '</pre>' : '<p class="text-slate-500">Keine Logs verfügbar</p>'; container.scrollTop = container.scrollHeight; } })
    .catch(e => { if (container) container.innerHTML = '<p class="text-red-400">Fehler: ' + escapeHtml(e.message) + '</p>'; })
    .finally(() => { logsLoading = false; spinner?.classList.add('hidden'); if (btnText) btnText.textContent = 'Aktualisieren'; });
}
{% if client.is_running %}setInterval(refreshLogs, 5000);{% endif %}

const connectForm = document.getElementById('connect-form');
if (connectForm) {
    connectForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const select = document.getElementById('target-slug-select'); if (!select) return;
        const selectedOption = select.options[select.selectedIndex]; const targetName = selectedOption.getAttribute('data-name');
        document.getElementById('connect-normal').classList.add('hidden'); document.getElementById('connect-loading').classList.remove('hidden'); document.getElementById('connect-loading-text').textContent = `Verbinde mit ${targetName}...`;
        try {
            const response = await fetch(CONNECT_URL, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN }, body: new FormData(connectForm) });
            const data = await response.json();
            if (data.success) { document.getElementById('connect-loading').classList.add('hidden'); document.getElementById('connect-success').classList.remove('hidden'); document.getElementById('connect-success-text').textContent = `Verbunden mit ${data.client_b}!`; addConnectionToList(data); setTimeout(hideConnectPanel, 1500); }
            else { document.getElementById('connect-loading').classList.add('hidden'); document.getElementById('connect-error').classList.remove('hidden'); document.getElementById('connect-error-text').textContent = data.error || 'Verbindung fehlgeschlagen'; }
        } catch (error) { document.getElementById('connect-loading').classList.add('hidden'); document.getElementById('connect-error').classList.remove('hidden'); document.getElementById('connect-error-text').textContent = 'Netzwerkfehler'; }
    });
}

function addConnectionToList(data) {
    const list = document.getElementById('connections-list'); if (!list) return;
    document.getElementById('no-connections-placeholder')?.remove();
    const newConn = document.createElement('div'); newConn.className = 'connection-item p-4 transition-all duration-300 hover:bg-slate-50 dark:hover:bg-slate-800/50 animate-fade-in'; newConn.setAttribute('data-connection-id', data.connection_id);
    newConn.innerHTML = `<div class="connection-normal flex items-center justify-between group"><div class="flex items-center gap-3"><span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span></span><div><span class="text-slate-900 dark:text-white font-medium">${escapeHtml(data.client_b)}</span><span class="text-slate-500 text-sm ml-1">(${escapeHtml(data.contact_name_on_a)})</span></div></div><div class="flex items-center gap-2"><span class="connection-status text-xs text-slate-500">Verbunden</span><button onclick="showDeleteConfirm('${data.connection_id}')" class="text-slate-400 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-500/10 transition-all opacity-0 group-hover:opacity-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></div><div class="connection-confirm hidden"><div class="flex items-center justify-between bg-red-500/10 rounded-lg p-3 -mx-1"><span class="text-red-500 text-sm">Verbindung wirklich löschen?</span><div class="flex items-center gap-2"><button onclick="cancelDelete('${data.connection_id}')" class="px-3 py-1 text-sm text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors">Abbrechen</button><button onclick="confirmDelete('${data.connection_id}')" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-500 text-white rounded transition-colors">Löschen</button></div></div></div><div class="connection-deleting hidden"><div class="flex items-center gap-3 text-slate-500"><svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-sm">Verbindung wird gelöscht...</span></div></div>`;
    list.insertBefore(newConn, list.firstChild);
    document.getElementById('send-message-container')?.classList.remove('hidden'); document.getElementById('no-connections-send-placeholder')?.classList.add('hidden');
    const contactSelect = document.getElementById('contact-select');
    if (contactSelect) { const option = document.createElement('option'); option.value = data.contact_name_on_a; option.setAttribute('data-recipient', data.client_b); option.textContent = `${data.client_b} (${data.contact_name_on_a})`; contactSelect.appendChild(option); }
    const targetSelect = document.getElementById('target-slug-select');
    if (targetSelect) { for (let i = 0; i < targetSelect.options.length; i++) { if (targetSelect.options[i].getAttribute('data-name') === data.client_b) { targetSelect.remove(i); break; } } if (targetSelect.options.length === 0) { document.getElementById('connections-header-normal')?.querySelector('button')?.style.setProperty('display', 'none'); } }
}

const sendForm = document.getElementById('send-message-form');
if (sendForm) {
    sendForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('send-btn'); const btnText = document.getElementById('send-btn-text'); const spinner = document.getElementById('send-spinner'); const feedback = document.getElementById('send-feedback'); const messageInput = document.getElementById('message-input'); const contactSelect = document.getElementById('contact-select');
        if (!contactSelect || contactSelect.options.length === 0) { feedback.className = 'text-sm text-center py-2 rounded-lg bg-red-500/20 text-red-400'; feedback.textContent = '✗ Kein Empfänger verfügbar'; feedback.classList.remove('hidden'); return; }
        const selectedOption = contactSelect.options[contactSelect.selectedIndex]; const recipientName = selectedOption?.getAttribute('data-recipient') || 'Unbekannt';
        btn.disabled = true; btnText.textContent = 'Senden...'; spinner.classList.remove('hidden'); feedback.classList.add('hidden');
        try {
            const response = await fetch(SEND_URL, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN }, body: new FormData(sendForm) });
            const data = await response.json();
            if (data.success) {
                feedback.className = 'text-sm text-center py-2 rounded-lg bg-emerald-500/20 text-emerald-400'; feedback.textContent = '✓ Nachricht gesendet!'; feedback.classList.remove('hidden');
                addMessageToTable(data.message_id, recipientName, messageInput.value, 'sent');
                const statSent = document.getElementById('stat-sent'); if (statSent && data.messages_sent !== undefined) { statSent.textContent = data.messages_sent; statSent.classList.add('stat-bump'); setTimeout(() => statSent.classList.remove('stat-bump'), 300); }
                messageInput.value = ''; setTimeout(() => feedback.classList.add('hidden'), 2000);
            } else { feedback.className = 'text-sm text-center py-2 rounded-lg bg-red-500/20 text-red-400'; feedback.textContent = '✗ ' + (data.error || 'Fehler beim Senden'); feedback.classList.remove('hidden'); }
        } catch (error) { feedback.className = 'text-sm text-center py-2 rounded-lg bg-red-500/20 text-red-400'; feedback.textContent = '✗ Netzwerkfehler'; feedback.classList.remove('hidden'); }
        btn.disabled = false; btnText.textContent = 'Senden'; spinner.classList.add('hidden');
    });
}

function addMessageToTable(messageId, recipient, content, status) {
    const now = new Date(); const timeStr = now.toTimeString().slice(0, 8);
    document.getElementById('no-sent-messages')?.remove(); document.getElementById('no-all-messages')?.remove();
    const sentRow = document.createElement('tr'); sentRow.className = 'hover:bg-slate-50 dark:hover:bg-slate-800/50 animate-fade-in'; sentRow.setAttribute('data-message-id', messageId);
    sentRow.innerHTML = `<td class="px-3 py-2 text-slate-500 text-sm whitespace-nowrap">${timeStr}</td><td class="px-3 py-2 text-slate-900 dark:text-white">${escapeHtml(recipient)}</td><td class="px-3 py-2 text-slate-600 dark:text-slate-300 max-w-xs truncate">${escapeHtml(content.substring(0, 30))}${content.length > 30 ? '...' : ''}</td><td class="px-3 py-2 msg-status"><span class="text-amber-500">✓</span></td><td class="px-3 py-2 text-right text-slate-500 text-xs msg-latency">-</td>`;
    document.getElementById('sent-messages-body')?.insertBefore(sentRow, document.getElementById('sent-messages-body').firstChild);
}

let clientSocket = null;
function connectWebSocket() {
    if (clientSocket?.readyState === WebSocket.OPEN) return;
    clientSocket = new WebSocket(`${WS_PROTOCOL}//${WS_HOST}/ws/clients/${CLIENT_SLUG}/`);
    clientSocket.onopen = () => console.log('WebSocket connected');
    clientSocket.onmessage = (e) => handleWebSocketMessage(JSON.parse(e.data));
    clientSocket.onclose = () => setTimeout(connectWebSocket, 3000);
    clientSocket.onerror = (e) => console.error('WebSocket error:', e);
}

function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'message_status_update':
            const rows = document.querySelectorAll(`tr[data-message-id="${data.message_id}"]`);
            rows.forEach(row => { const statusCell = row.querySelector('.msg-status'); const latencyCell = row.querySelector('.msg-latency'); if (statusCell) { if (data.status === 'delivered') statusCell.innerHTML = '<span class="text-emerald-500">✓✓</span>'; else if (data.status === 'failed') statusCell.innerHTML = '<span class="text-red-500">✗</span>'; } if (latencyCell && data.latency_ms) latencyCell.textContent = data.latency_ms + 'ms'; });
            break;
        case 'message_received':
            const statReceived = document.getElementById('stat-received'); if (statReceived) { statReceived.textContent = parseInt(statReceived.textContent) + 1; statReceived.classList.add('stat-bump'); setTimeout(() => statReceived.classList.remove('stat-bump'), 300); }
            break;
        case 'stats_update':
            if (data.messages_sent !== undefined) { const el = document.getElementById('stat-sent'); if (el) { el.textContent = data.messages_sent; el.classList.add('stat-bump'); setTimeout(() => el.classList.remove('stat-bump'), 300); } }
            break;
    }
}

{% if client.is_running %}connectWebSocket();{% endif %}
</script>
{% endblock %}